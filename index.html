<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <title>Web Speech API Demo</title>

      <style>
      /* NOTE: The styles were added inline because Prefixfree needs access to your styles and they must be inlined if they are on local disk! */
      body {
  background-color: black;
  font-size:30em;
  text-align: center;
  color:#2F2;
  font-family: monospace;
}
#face:after {
  content:'^_^';
}
#face.talking:after {
  animation-name: talk;
  animation-duration: 1s;
  animation-iteration-count: infinite;
  content:'ﾟoﾟ'
}
@keyframes talk {
    0%   {content:'ﾟoﾟ'}
    50%  {content:'ﾟOﾟ'}
}

/*
essential styles:
these make the slideshow work
*/

#slides {
    position: relative;
    height: 300px;
    padding: 0px;
    margin: 0px;
    list-style-type: none;
}

.slide {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 100%;
    height: 100%;
    opacity: 0;
    z-index: 1;

    -webkit-transition: opacity 1s;
    -moz-transition: opacity 1s;
    -o-transition: opacity 1s;
    transition: opacity 1s;
}

.showing {
    opacity: 1;
    z-index: 2;
}
    </style>
</head>
<body>
 <script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script>
//  https://www.talater.com/annyang/

if (annyang) {
  var currentMonolog, currentImages;
  var wikipedia = function(word) {
    var url = '//sv.wikipedia.org/w/api.php?action=query&redirects=1&prop=images%7Cextracts&format=json&callback=?&exintro=&titles='+word;
    $.ajax({
        type: "GET",
        url: url,
        contentType: "application/json; charset=utf-8",
        async: false,
        dataType: "json",
        success: function (data, textStatus, jqXHR) {
            console.log(data);
            if (data.query && data.query.pages) {
              currentMonolog = [];
              var result = data.query.pages;
              if (result[-1] == undefined) {
                var page = result[Object.keys(result)[0]],
                  markup = page.extract;
                  blurb = $('<div></div>').html(markup).text();
                fetchWikiImages(page);
                currentMonolog = blurb.split('.');
                currentMonolog.unshift(word);
                tellMore(4);
              } else {
                snacka('Jag vet tyvärr inget om ' + word);
              }

            }
        },
        error: function (errorMessage) {
          snacka('Jag vet tyvärr inget om det');
        }
    });
  };

  var fetchWikiImages = function(page) {
    $('#slides').html('');
    if (page['images']) {
      for (var i = 0, len = page['images'].length; i < len; i++) {
        var image = page['images'][i],
          title = image['title'],
          imageUrlQuery;
        if(title != 'Fil:Commons-logo.svg' 
          && title != 'Fil:P vip.svg') {
            title = title.replace('Fil:', '').replace(' ', '_');
            imageUrlQuery = "//sv.wikipedia.org/w/api.php?action=query&titles=Bild:" + title + "&prop=imageinfo&iiprop=url&format=json&callback=?";
            $.ajax({
              type: "GET",
              url: imageUrlQuery,
              contentType: "application/json; charset=utf-8",
              async: false,
              dataType: "json",
              success: function (data, textStatus, jqXHR) {
                var result = data.query.pages,
                  page = result[Object.keys(result)[0]],
                  url = page['imageinfo'][0]['url'];
                  addSlide(url);
              },
              error: function (errorMessage) {}
            });
        }
      }
    }
  }
    var slides,
     currentSlide,
    slideInterval;

  var addSlide = function(image) {
    $('#slides').append('<li class="slide"><img src="' + image + '"></li>');
    slides = document.querySelectorAll('#slides .slide');
    currentSlide = 0;
    clearInterval(slideInterval);
    slideInterval = setInterval(nextSlide,2000);

    function nextSlide() {
        slides[currentSlide].className = 'slide';
        currentSlide = (currentSlide+1)%slides.length;
        slides[currentSlide].className = 'slide showing';
    }
  };

  var hello = function() {
      snacka('Hej! Vad heter du?');
      annyang.addCommands({
        '(Jag heter) *name': yourName
      });
  };

  var yourName = function(name) {
      snacka('Hej ' + name + ', trevligt att träffas');
      annyang.removeCommands('(Jag heter) *name');
  };

  var tellMore = function(num) {
    var text = '',
      isMore = false;

    if (currentMonolog.length) {
      if (!num) {
        text = currentMonolog.join('.');
        currentMonolog = [];
      } else {
        if (currentMonolog.length < num) {
          num = currentMonolog.length;
        }
        for (var i = 0; i < num; i++) {
          text += currentMonolog.shift() + '.';
        };
        if (currentMonolog.length) {
          text += ' Ska jag berätta mer?';
          isMore = true;
        }
      }

      snacka(text);

      if (isMore) {
        annyang.addCommands({
          'Ja': tellMore
        });
      } else {
        annyang.removeCommands('Ja');
      }

    }
  };

  var commands = {
    // annyang will capture anything after a splat (*) and pass it to the function.
    // e.g. saying "Show me Batman and Robin" is the same as calling showFlickr('Batman and Robin');
    'Vad är (en)(ett) *word( för något)': wikipedia,
    'Berätta om *word': wikipedia,
    'Prata om *word': wikipedia,
    'Vad betyder *word': wikipedia,
    'Hur gör man *word': wikipedia,
    'Var ligger *word': wikipedia,
    'Vem är *word': wikipedia,
    'Vad äter *word': wikipedia,
    'Var bor (det) *word': wikipedia,
    'Var finns det *word': wikipedia,
    'Vad kan du om *word': wikipedia,
    'Vad vet du om *word': wikipedia,
    'Vet du något om *word': wikipedia,
    'Kan du något om *word': wikipedia,

    'Berätta mer': tellMore,
    'Mer': tellMore,
    'Ja (tack)(gärna)': tellMore,

    'Hej( robot)': hello,
    'length': 1
  };

  // Add our commands to annyang
  annyang.init(commands);
  annyang.setLanguage('sv-SE');

  annyang.debug();

  // Start listening. You can call this here, or attach this call to an event, button, etc.
  annyang.start();

  var snacka = function(text) {
    annyang.abort();
    var msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'sv-SE';
    msg.onend = function (event) {
      console.log('End talk');
      annyang.start();
      $('#face').removeClass('talking');
    };
    window.speechSynthesis.speak(msg);
    $('#face').addClass('talking');
  }
};




</script>
<div id="container">
  <div id="face"></div>
  <ul id="slides"></ul>
</div>
</body>
</html>
