<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <title>Web Speech API Demo</title>

      <style>
      /* NOTE: The styles were added inline because Prefixfree needs access to your styles and they must be inlined if they are on local disk! */
      body {
  background-color: black;
  font-size:30em;
  text-align: center;
  color:#2F2;
}
#face:after {
  content:'^_^';
}
#face.talking:after {
  animation-name: talk;
  animation-duration: 1s;
  animation-iteration-count: infinite;
}
@keyframes talk {
    0%   {content:'^=^'}
    50%  {content:'^o^'}
}


    </style>
</head>
<body>
 <script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script>
//  https://www.talater.com/annyang/

if (annyang) {
  var currentMonolog;
  var wikipedia = function(word) {
    var url = '//sv.wikipedia.org/w/api.php?action=query&redirects=1&prop=extracts&format=json&callback=?&exintro=&titles='+word;
    $.ajax({
        type: "GET",
        url: url,
        contentType: "application/json; charset=utf-8",
        async: false,
        dataType: "json",
        success: function (data, textStatus, jqXHR) {
            console.log(data);
            if (data.query && data.query.pages) {
              currentMonolog = [];
              var result = data.query.pages;
              if (result[-1] == undefined) {
                var markup = result[Object.keys(result)[0]].extract;
                var blurb = $('<div></div>').html(markup).text();
                currentMonolog = blurb.split('.');
                currentMonolog.unshift(word);
                tellMore(2);
              } else {
                snacka('Jag vet tyvärr inget om ' . word);
              }

            }
        },
        error: function (errorMessage) {
          snacka('Jag vet tyvärr inget om det');
        }
    });

    //snacka('Menar du ' + tag + '?');
  };

  var hello = function() {
      snacka('Hej! Vad heter du?');
      annyang.addCommands({
        '(Jag heter) *name': yourName
      })
  };


  var yourName = function(name) {
      snacka('Hej ' + name + ', trevligt att träffas');
      annyang.removeCommands('(Jag heter) *name');
  };

  var tellMore = function(num) {
    console.log(currentMonolog);
    var text = '';
    if (currentMonolog.length) {
      if (!num) {
        text = currentMonolog.join('.');
        currentMonolog = [];
      } else {
        if (currentMonolog.length < num) {
          num = currentMonolog.length;
        }
        for (var i = 0; i < num; i++) {
          text += currentMonolog.shift() + '.';
        };
        if (currentMonolog.length) {
          text += 'Vill du veta mer?';
        }
      }
      snacka(text);
    }
  };

  //snacka('Menar du ' + tag + '?');
  };
  var commands = {
    // annyang will capture anything after a splat (*) and pass it to the function.
    // e.g. saying "Show me Batman and Robin" is the same as calling showFlickr('Batman and Robin');
    'Vad är (en)(ett) *word( för något)': wikipedia,
    'Berätta om *word': wikipedia,
    'Prata om *word': wikipedia,
    'Vad betyder *word': wikipedia,
    'Hur gör man *word': wikipedia,
    'Var ligger *word': wikipedia,
    'Vad äter *word': wikipedia,
    'Var bor (det) *word': wikipedia,
    'Var finns det *word': wikipedia,
    'Vad kan du om *word': wikipedia,
    'Vad vet du om *word': wikipedia,
    'Vet du något om *word': wikipedia,
    'Kan du något om *word': wikipedia,

    'Berätta mer': tellMore,
    'Mer': tellMore,
    'Ja (tack)(gärna)': tellMore,

    'Hej( robot)': hello,
    'length': 2
  };

  // Add our commands to annyang
  annyang.init(commands);
  annyang.setLanguage('sv-SE');

  annyang.debug();

  // Start listening. You can call this here, or attach this call to an event, button, etc.
  annyang.start();

  var snacka = function(text) {
    annyang.abort();
    var msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'sv-SE';
    msg.onend = function (event) {
      console.log('End talk');
      annyang.start();
      $('#face').removeClass('talking');
    };
    window.speechSynthesis.speak(msg);
    $('#face').addClass('talking');
  }




</script>
<div id="face"></div>
</body>
</html>
